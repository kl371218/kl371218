# UN Country Contributions PDF Parser

This repository contains UN country contributions PDF files and tools for parsing them. The PDFs have different layouts over time, so an automated classifier helps select the correct parser configuration.

## PDF Layout Classifier

The PDF layout classifier automatically analyzes UN country contributions PDF files to determine their layout type, enabling automatic selection of the correct parser configuration.

### Layout Types

The classifier identifies three main layout patterns:

- **A_mission_country**: Country appears first in column headers (typical for 2015-2018 files)
  - Header format: `Country | UN Mission | Description | M | F | Totals`
  
- **B_country_post**: Mission appears first in column headers (typical for 2019+ files)  
  - Header format: `Mission | Country | Description | Male | Female | Total`
  
- **C_country_unmission**: Special pipe-separated format (rare)
  - Header format: `Country | UN Mission | Description` with explicit separators

### Usage

#### Quick Classification

Run the classifier on all PDF files in the repository:

```bash
Rscript scripts/classify_pdf_layouts.R
```

This will:
1. Scan for all `UN_country_contributions_*.pdf` files
2. Analyze the first page of each PDF 
3. Classify the layout type using header pattern detection
4. Save results to `outputs/pdf_layouts.csv`
5. Print a summary of layout counts

#### Example Runner

For testing or demonstrations, use the example runner:

```bash
# Classify a sample of 10 files
Rscript scripts/run_classification_example.R

# Classify a sample of 20 files  
Rscript scripts/run_classification_example.R 20

# Classify all files
Rscript scripts/run_classification_example.R full
```

#### Using Results with Parser

After running the classifier, use the `outputs/pdf_layouts.csv` file to select the correct parser configuration:

```r
# Load classification results
layouts <- read_csv("outputs/pdf_layouts.csv")

# Get layout for specific file
file_layout <- layouts$layout[layouts$filename == "UN_country_contributions_2024_01.pdf"]

# Configure parser based on layout
if (file_layout == "A_mission_country") {
  parser_config <- list(country_first = TRUE, mission_col = 2, ...)
} else if (file_layout == "B_country_post") {  
  parser_config <- list(country_first = FALSE, mission_col = 1, ...)
}
```

### Output Format

The classifier outputs a CSV file with these columns:

- `filename`: PDF filename
- `layout`: Detected layout type (A_mission_country, B_country_post, C_country_unmission, unknown, error)
- `report_date`: Extracted report date (from filename or PDF content)
- `sample_header_line`: Sample header text from the PDF
- `notes`: Classification reasoning and details

### Classification Method

The classifier uses multiple detection methods in order of preference:

1. **Header Pattern Analysis**: Examines column header structure to identify layout
2. **Token Position Analysis**: Uses PDF coordinate data to determine column order  
3. **Year-based Fallback**: Applies historical patterns when header analysis fails
   - 2015-2018: Typically Layout A (Country-first)
   - 2019+: Typically Layout B (Mission-first)

### Requirements

- R with packages: `pdftools`, `dplyr`, `purrr`, `stringr`, `tibble`, `readr`
- `poppler-utils` system library for PDF processing

Install on Ubuntu/Debian:
```bash
sudo apt-get install r-base r-cran-pdftools r-cran-dplyr r-cran-purrr r-cran-stringr r-cran-tibble r-cran-readr
```

### Files

- `scripts/classify_pdf_layouts.R` - Main classifier script
- `scripts/run_classification_example.R` - Example runner and testing script  
- `outputs/pdf_layouts.csv` - Classification results (generated)
- `outputs/pdf_layouts_sample.csv` - Sample results (generated by example runner)